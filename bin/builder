#!/usr/bin/env python3
import os
import sys
import json
import argparse
import asyncio
from typing import Dict, Any, List, Optional
import time

# Add the parent directory to the path so we can import the modules
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from utils.logger import setup_logging
from playwright.async_api import async_playwright, Page, Browser, ElementHandle

# Set up logger
from utils.logger import get_logger
logger = get_logger('builder')

class InteractiveSelector:
    """Interactive element selector using Playwright"""
    
    def __init__(self, url: str, source_id: str):
        self.url = url
        self.source_id = source_id
        self.browser = None
        self.page = None
        self.selections = {}
        self.active_field = None
        self.multi_select_mode = False
        self.multi_selected_elements = []
        
    async def setup(self):
        """Set up the browser and UI"""
        playwright = await async_playwright().start()
        self.browser = await playwright.chromium.launch(headless=False)
        
        # Create a context with a decent size
        context = await self.browser.new_context(
            viewport={'width': 1366, 'height': 768}
        )
        
        # Open the page
        self.page = await context.new_page()
        await self.page.goto(self.url)
        
        # Add the control panel to the page
        await self._inject_control_panel()
        
        # Add event handlers
        await self._setup_event_handlers()
        
        return self
        
    async def _inject_control_panel(self):
        """Inject the control panel into the page"""
        # Add the CSS
        await self.page.add_style_tag(content="""
            #scraper-builder-panel {
                position: fixed;
                top: 20px;
                right: 20px;
                width: 300px;
                background-color: white;
                border: 1px solid #ccc;
                border-radius: 8px;
                box-shadow: 0 0 10px rgba(0,0,0,0.2);
                z-index: 9999;
                font-family: Arial, sans-serif;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            #scraper-builder-panel h2 {
                margin-top: 0;
                margin-bottom: 15px;
                border-bottom: 1px solid #eee;
                padding-bottom: 8px;
            }
            
            .field-button {
                display: block;
                width: 100%;
                padding: 8px;
                margin-bottom: 8px;
                background-color: #f1f1f1;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
                text-align: left;
            }
            
            .field-button.active {
                background-color: #4CAF50;
                color: white;
            }
            
            .custom-field {
                display: flex;
                margin-bottom: 8px;
            }
            
            .custom-field input {
                flex-grow: 1;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px 0 0 4px;
            }
            
            .custom-field button {
                padding: 8px;
                border: 1px solid #ddd;
                border-left: none;
                border-radius: 0 4px 4px 0;
                background-color: #f1f1f1;
                cursor: pointer;
            }
            
            .multi-select {
                margin: 10px 0;
            }
            
            .selected-fields {
                margin-top: 15px;
                border-top: 1px solid #eee;
                padding-top: 10px;
            }
            
            .field-item {
                padding: 8px;
                margin-bottom: 8px;
                background-color: #f9f9f9;
                border: 1px solid #ddd;
                border-radius: 4px;
                position: relative;
            }
            
            .field-item .delete {
                position: absolute;
                right: 8px;
                top: 8px;
                color: #f44336;
                cursor: pointer;
                font-weight: bold;
            }
            
            .field-name {
                font-weight: bold;
                margin-bottom: 4px;
            }
            
            .field-sample {
                font-size: 0.8em;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .actions {
                display: flex;
                justify-content: space-between;
                margin-top: 15px;
            }
            
            .actions button {
                padding: 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            
            .actions .primary {
                background-color: #4CAF50;
                color: white;
            }
            
            .actions .secondary {
                background-color: #f1f1f1;
            }
            
            .sb-element-hover {
                outline: 2px solid blue !important;
                background-color: rgba(0, 0, 255, 0.1) !important;
            }
            
            .sb-element-selected {
                outline: 2px solid green !important;
                background-color: rgba(0, 255, 0, 0.1) !important;
            }
            
            .sb-element-multi-selected {
                outline: 2px dashed green !important;
                background-color: rgba(0, 255, 0, 0.05) !important;
            }
            
            #scraper-builder-toast {
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0,0,0,0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                display: none;
                z-index: 10000;
            }
        """)
        
        # Add the control panel HTML
        await self.page.evaluate("""() => {
            // Create the control panel
            const panel = document.createElement('div');
            panel.id = 'scraper-builder-panel';
            panel.innerHTML = `
                <h2>Scraper Builder</h2>
                <div>
                    <p>Select a field type, then click on elements in the page to extract.</p>
                    <div id="field-buttons">
                        <button class="field-button" data-field="title">title</button>
                        <button class="field-button" data-field="published_date">published_date</button>
                        <button class="field-button" data-field="author">author</button>
                        <button class="field-button" data-field="content">content</button>
                        <button class="field-button" data-field="claims">claims</button>
                    </div>
                    <div class="custom-field">
                        <input type="text" id="custom-field-name" placeholder="Custom field name">
                        <button id="add-custom-field">Add</button>
                    </div>
                    <div class="multi-select">
                        <label>
                            <input type="checkbox" id="multi-select-mode"> Multi-select mode 
                            <small>(for content paragraphs)</small>
                        </label>
                    </div>
                </div>
                <div class="selected-fields">
                    <h3>Selected Fields</h3>
                    <div id="selected-fields">
                        <p>No fields selected yet</p>
                    </div>
                </div>
                <div class="actions">
                    <button id="reset-btn" class="secondary">Reset All</button>
                    <button id="generate-btn" class="primary">Generate Scraper</button>
                </div>
            `;
            
            // Create toast element
            const toast = document.createElement('div');
            toast.id = 'scraper-builder-toast';
            
            // Add to page
            document.body.appendChild(panel);
            document.body.appendChild(toast);
            
            // Element to store the result
            const resultElement = document.createElement('div');
            resultElement.id = 'scraper-builder-result';
            resultElement.style.display = 'none';
            document.body.appendChild(resultElement);
        }""")
    
    async def _setup_event_handlers(self):
        """Set up event handlers for the control panel and page elements"""
        # Set up field buttons
        await self.page.evaluate("""() => {
            // Create a global object to store state
            window.scraperBuilder = {
                activeField: null,
                multiSelectMode: false,
                multiSelectedElements: [],
                selections: {},
                
                // Show a toast message
                showToast: function(message, duration = 3000) {
                    const toast = document.getElementById('scraper-builder-toast');
                    toast.textContent = message;
                    toast.style.display = 'block';
                    
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, duration);
                },
                
                // Update the selected fields UI
                updateSelectedFields: function() {
                    console.log('Updating selected fields');
                    
                    const container = document.getElementById('selected-fields');
                    
                    if (Object.keys(this.selections).length === 0) {
                        container.innerHTML = '<p>No fields selected yet</p>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    
                    for (const [field, data] of Object.entries(this.selections)) {
                        const item = document.createElement('div');
                        item.className = 'field-item';
                        item.innerHTML = `
                            <span class="delete" data-field="${field}">Ã—</span>
                            <div class="field-name">${field}</div>
                            <div class="field-sample">${data.sample}</div>
                        `;
                        container.appendChild(item);
                    }
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.field-item .delete').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const field = this.getAttribute('data-field');
                            
                            // Clear highlighting
                            document.querySelectorAll(`.sb-element-selected[data-field="${field}"]`).forEach(el => {
                                el.classList.remove('sb-element-selected');
                                el.removeAttribute('data-field');
                            });
                            
                            delete window.scraperBuilder.selections[field];
                            window.scraperBuilder.updateSelectedFields();
                        });
                    });
                }
            };
            
            // Set up field buttons
            document.querySelectorAll('.field-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    console.log(`Field button clicked: ${field}`);
                    
                    // Deactivate all buttons
                    document.querySelectorAll('.field-button').forEach(b => 
                        b.classList.remove('active'));
                    
                    // Toggle active field
                    if (window.scraperBuilder.activeField === field) {
                        window.scraperBuilder.activeField = null;
                        window.scraperBuilder.showToast('Field selection cancelled');
                        return;
                    }
                    
                    // Activate this field
                    this.classList.add('active');
                    window.scraperBuilder.activeField = field;
                    window.scraperBuilder.showToast(`Click on the ${field} element in the page`);
                });
            });
            
            // Custom field button
            document.getElementById('add-custom-field').addEventListener('click', function() {
                const input = document.getElementById('custom-field-name');
                const fieldName = input.value.trim();
                
                if (!fieldName) {
                    window.scraperBuilder.showToast('Please enter a field name');
                    return;
                }
                
                // Create new button
                const btn = document.createElement('button');
                btn.className = 'field-button';
                btn.setAttribute('data-field', fieldName);
                btn.textContent = fieldName;
                
                // Add click handler
                btn.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    
                    // Deactivate all buttons
                    document.querySelectorAll('.field-button').forEach(b => 
                        b.classList.remove('active'));
                    
                    // Toggle active field
                    if (window.scraperBuilder.activeField === field) {
                        window.scraperBuilder.activeField = null;
                        window.scraperBuilder.showToast('Field selection cancelled');
                        return;
                    }
                    
                    // Activate this field
                    this.classList.add('active');
                    window.scraperBuilder.activeField = field;
                    window.scraperBuilder.showToast(`Click on the ${field} element in the page`);
                });
                
                // Add to UI
                document.getElementById('field-buttons').appendChild(btn);
                input.value = '';
                
                // Activate new field
                window.scraperBuilder.activeField = fieldName;
                btn.classList.add('active');
                window.scraperBuilder.showToast(`Now select the ${fieldName} element`);
            });
            
            // Multi-select mode toggle
            document.getElementById('multi-select-mode').addEventListener('change', function() {
                window.scraperBuilder.multiSelectMode = this.checked;
                
                if (!this.checked) {
                    // Clear multi-selections when turning off
                    document.querySelectorAll('.sb-element-multi-selected').forEach(el => {
                        el.classList.remove('sb-element-multi-selected');
                    });
                    window.scraperBuilder.multiSelectedElements = [];
                }
                
                window.scraperBuilder.showToast(
                    this.checked ? 'Multi-select mode enabled' : 'Single element selection mode'
                );
            });
            
            // Reset button
            document.getElementById('reset-btn').addEventListener('click', function() {
                // Clear all selections
                document.querySelectorAll('.sb-element-selected, .sb-element-multi-selected').forEach(el => {
                    el.classList.remove('sb-element-selected');
                    el.classList.remove('sb-element-multi-selected');
                    el.removeAttribute('data-field');
                });
                
                // Reset state
                window.scraperBuilder.activeField = null;
                window.scraperBuilder.multiSelectedElements = [];
                window.scraperBuilder.selections = {};
                
                // Reset UI
                document.querySelectorAll('.field-button').forEach(btn => 
                    btn.classList.remove('active'));
                document.getElementById('multi-select-mode').checked = false;
                window.scraperBuilder.multiSelectMode = false;
                
                window.scraperBuilder.updateSelectedFields();
                window.scraperBuilder.showToast('All selections reset');
            });
            
            // Generate button
            document.getElementById('generate-btn').addEventListener('click', function() {
                console.log('Generate button clicked');
                
                if (Object.keys(window.scraperBuilder.selections).length === 0) {
                    window.scraperBuilder.showToast('Please select at least one field first');
                    return;
                }
                
                // Disable button
                this.disabled = true;
                this.textContent = 'Generating...';
                
                // Show message
                window.scraperBuilder.showToast('Generating scraper...', 10000);
                
                // Store the selections in the result element
                const resultElement = document.getElementById('scraper-builder-result');
                resultElement.setAttribute('data-selections', 
                    JSON.stringify(window.scraperBuilder.selections));
                
                // Signal completion
                window.scraperBuilder.showToast('Scraper generated! You may close this window.');
            });
            
            // Show initial instructions
            window.scraperBuilder.showToast('Select a field to begin', 5000);
        }""")
        
        # Add hover highlighting
        await self.page.evaluate("""() => {
            let currentHoveredElement = null;
            
            // Handle mouseover events
            document.addEventListener('mouseover', function(event) {
                // Only highlight if a field is active
                if (!window.scraperBuilder || !window.scraperBuilder.activeField) return;
                
                // Skip the builder panel itself
                if (event.target.closest('#scraper-builder-panel') || 
                    event.target.closest('#scraper-builder-toast')) return;
                
                // Clear previous hover
                if (currentHoveredElement) {
                    currentHoveredElement.classList.remove('sb-element-hover');
                }
                
                // Add hover to current element
                event.target.classList.add('sb-element-hover');
                currentHoveredElement = event.target;
            }, true);
            
            // Handle mouseout events
            document.addEventListener('mouseout', function(event) {
                // Skip the builder panel itself
                if (event.target.closest('#scraper-builder-panel') || 
                    event.target.closest('#scraper-builder-toast')) return;
                
                event.target.classList.remove('sb-element-hover');
                if (currentHoveredElement === event.target) {
                    currentHoveredElement = null;
                }
            }, true);
        }""")
    
    async def _setup_click_handler(self):
        """Add click handler to capture element selections"""
        # Handle click events for element selection
        await self.page.evaluate("""() => {
            document.addEventListener('click', function(event) {
                // Only process clicks if a field is active
                if (!window.scraperBuilder || !window.scraperBuilder.activeField) return;
                
                // Skip clicks on the builder panel itself
                if (event.target.closest('#scraper-builder-panel') || 
                    event.target.closest('#scraper-builder-toast')) return;
                
                // Prevent the default action (following links, etc.)
                event.preventDefault();
                event.stopPropagation();
                
                const field = window.scraperBuilder.activeField;
                
                if (window.scraperBuilder.multiSelectMode) {
                    // Multi-select mode (for content paragraphs)
                    if (event.target.classList.contains('sb-element-multi-selected')) {
                        // Deselect if already selected
                        event.target.classList.remove('sb-element-multi-selected');
                        window.scraperBuilder.multiSelectedElements = 
                            window.scraperBuilder.multiSelectedElements.filter(el => el !== event.target);
                    } else {
                        // Add to selection
                        event.target.classList.add('sb-element-multi-selected');
                        event.target.dataset.field = field;
                        window.scraperBuilder.multiSelectedElements.push(event.target);
                    }
                    
                    // Update selection if we have elements
                    if (window.scraperBuilder.multiSelectedElements.length > 0) {
                        // Get the tag name for selector
                        const tagName = window.scraperBuilder.multiSelectedElements[0].tagName.toLowerCase();
                        
                        // Get text samples
                        const texts = [];
                        window.scraperBuilder.multiSelectedElements.forEach(el => {
                            texts.push(el.textContent.trim());
                        });
                        
                        const sample = texts.join(' ').substring(0, 100) + 
                            (texts.join(' ').length > 100 ? '...' : '');
                        
                        // Store the selection
                        window.scraperBuilder.selections[field] = {
                            selector: tagName,
                            selector_type: 'css',
                            sample: sample,
                            is_multi: true,
                            count: window.scraperBuilder.multiSelectedElements.length
                        };
                        
                        // Update UI
                        window.scraperBuilder.updateSelectedFields();
                        window.scraperBuilder.showToast(
                            `Updated ${field} with ${window.scraperBuilder.multiSelectedElements.length} elements`
                        );
                    }
                } else {
                    // Single element selection
                    // Remove any previous selection for this field
                    document.querySelectorAll(`.sb-element-selected[data-field="${field}"]`).forEach(el => {
                        el.classList.remove('sb-element-selected');
                        delete el.dataset.field;
                    });
                    
                    // Select this element
                    event.target.classList.add('sb-element-selected');
                    event.target.dataset.field = field;
                    
                    // Generate selector for this element
                    let selector;
                    
                    // Try ID
                    if (event.target.id) {
                        selector = '#' + event.target.id;
                    } else {
                        // Try classes
                        const validClasses = Array.from(event.target.classList)
                            .filter(c => !c.startsWith('sb-'));
                            
                        if (validClasses.length > 0) {
                            // Use the first class that's unique enough
                            for (const cls of validClasses) {
                                if (document.querySelectorAll('.' + cls).length < 5) {
                                    selector = '.' + cls;
                                    break;
                                }
                            }
                        }
                        
                        // Fall back to tag name and position
                        if (!selector) {
                            // Start with tag name
                            selector = event.target.tagName.toLowerCase();
                            
                            // Add nth-child if needed for more specificity
                            let parent = event.target.parentElement;
                            if (parent) {
                                let count = 1;
                                let sibling = event.target;
                                
                                while (sibling.previousElementSibling) {
                                    if (sibling.previousElementSibling.tagName === event.target.tagName) {
                                        count++;
                                    }
                                    sibling = sibling.previousElementSibling;
                                }
                                
                                if (count > 1) {
                                    selector = `${selector}:nth-of-type(${count})`;
                                }
                            }
                        }
                    }
                    
                    // Get text sample
                    const sample = event.target.textContent.trim().substring(0, 100) + 
                        (event.target.textContent.trim().length > 100 ? '...' : '');
                    
                    // Store the selection
                    window.scraperBuilder.selections[field] = {
                        selector: selector,
                        selector_type: 'css',
                        sample: sample,
                        is_multi: false
                    };
                    
                    // Update UI
                    window.scraperBuilder.updateSelectedFields();
                    window.scraperBuilder.showToast(`Selected element for ${field}`);
                }
                
                return false;
            }, true);
        }""")
    
    async def run(self) -> Dict[str, Any]:
        """Run the interactive selection process"""
        # Set up click handler
        await self._setup_click_handler()
        
        # Show welcome message
        await self.page.evaluate("""() => {
            window.scraperBuilder.showToast('Welcome to the Scraper Builder! Click a field to start.', 5000);
        }""")
        
        # Wait for selections to be completed (when the Generate button is clicked)
        logger.info("Waiting for user to complete selections and click Generate...")
        
        # Maximum wait time (30 minutes)
        timeout = 30 * 60  # 30 minutes
        interval = 2  # Check every 2 seconds
        start_time = time.time()
        
        while (time.time() - start_time) < timeout:
            # Check if selections have been made
            has_selections = await self.page.evaluate("""
                () => {
                    const resultElement = document.getElementById('scraper-builder-result');
                    return resultElement && resultElement.hasAttribute('data-selections');
                }
            """)
            
            if has_selections:
                # Get the selections
                selections_json = await self.page.evaluate("""
                    () => document.getElementById('scraper-builder-result').getAttribute('data-selections')
                """)
                
                selections = json.loads(selections_json)
                logger.info(f"Received selections: {len(selections)} fields")
                
                # Convert selections to the format expected by ScraperBuilder
                processed_selections = {}
                for field, data in selections.items():
                    processed_selections[field] = {
                        'selector': data['selector'],
                        'selector_type': data['selector_type'],
                        'sample_text': data['sample'],
                        'is_array': data.get('is_multi', False)
                    }
                
                return processed_selections
            
            # Wait before checking again
            await asyncio.sleep(interval)
            
            # Print status every minute
            elapsed = time.time() - start_time
            if int(elapsed) % 60 == 0 and int(elapsed) > 0:
                minutes = int(elapsed) // 60
                logger.info(f"Still waiting for selections... ({minutes} minute(s) elapsed)")
        
        # Timeout reached
        logger.error("Timeout waiting for selections")
        return {}
    
    async def close(self):
        """Close the browser"""
        if self.browser:
            await self.browser.close()

async def create_scraper(source_id: str, url: str) -> Dict[str, Any]:
    """
    Create a new scraper using an interactive browser-based selector
    
    Args:
        source_id: Identifier for the source
        url: URL of an example article to build the scraper from
        
    Returns:
        Dict containing the selections and paths to generated files
    """
    logger.info(f"Creating scraper for {source_id} using URL: {url}")
    
    # Create the interactive selector
    selector = await InteractiveSelector(url, source_id).setup()
    
    try:
        # Run the interactive selection process
        selections = await selector.run()
        
        if not selections:
            logger.error("No selections were made")
            await selector.close()
            return None
        
        # Generate scraper code
        from utils.scraper_builder import ScraperBuilder
        builder = ScraperBuilder(source_id)
        builder.base_url = url
        builder.selections = selections
        
        # Save configuration and code
        config_path = await builder.save_config()
        scraper_path = await builder.save_scraper_code()
        
        # Close the browser
        await selector.close()
        
        return {
            'config_path': config_path,
            'scraper_path': scraper_path,
            'selections': selections
        }
        
    except Exception as e:
        logger.error(f"Error creating scraper: {e}")
        await selector.close()
        raise

def main():
    # Set up argument parser
    parser = argparse.ArgumentParser(description='Interactive scraper builder tool')
    parser.add_argument('source_id', help='Unique identifier for the source (e.g., "example_source")')
    parser.add_argument('url', help='URL of an example article to use for building the scraper')
    
    # Parse arguments
    args = parser.parse_args()
    
    # Set up logging
    setup_logging('builder')
    
    # Run the interactive builder
    print(f"Starting interactive scraper builder for {args.source_id}")
    print(f"Using example article: {args.url}")
    print("A browser window will open. Follow the instructions to select elements.")
    print("Press Ctrl+C at any time to exit.")
    
    try:
        result = asyncio.run(create_scraper(args.source_id, args.url))
        
        if result:
            print("\n===== Builder Complete =====")
            print(f"Configuration saved to: {result['config_path']}")
            print(f"Scraper code saved to: {result['scraper_path']}")
            print("You can now edit the generated scraper to customize it further.")
        else:
            print("\n===== Builder Failed =====")
            print("No selections were made or an error occurred.")
        
    except KeyboardInterrupt:
        print("\nBuilder interrupted by user.")
        sys.exit(1)
    except Exception as e:
        print(f"\nError: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()