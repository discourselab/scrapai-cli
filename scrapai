#!/usr/bin/env python3
"""
scrapai - Simple Scrapy CLI for running Claude Code generated spiders
"""

import argparse
import subprocess
import sys
import os
from pathlib import Path

def check_venv():
    """Check if we're in a virtual environment, warn if not"""
    if not hasattr(sys, 'real_prefix') and not (hasattr(sys, 'base_prefix') and sys.base_prefix != sys.prefix):
        venv_path = Path('.venv')
        if venv_path.exists():
            print("âš ï¸  Virtual environment detected but not activated!")
            print("Run: source .venv/bin/activate")
            print("Then try again.\n")
        else:
            print("âš ï¸  No virtual environment found!")
            print("Run: uv venv && source .venv/bin/activate && uv pip install -r requirements.txt")
            print("Then try again.\n")
        return False
    return True

def main():
    if not check_venv():
        sys.exit(1)
    
    parser = argparse.ArgumentParser(description='Run Scrapy spiders generated by Claude Code')
    subparsers = parser.add_subparsers(dest='command', help='Available commands')
    
    # crawl command
    crawl_parser = subparsers.add_parser('crawl', help='Run a spider')
    crawl_parser.add_argument('spider', help='Spider name to run')
    crawl_parser.add_argument('--output', '-o', help='Output file path')
    crawl_parser.add_argument('--limit', '-l', type=int, help='Limit number of items')
    
    # list command
    subparsers.add_parser('list', help='List available spiders')
    
    # test command
    test_parser = subparsers.add_parser('test', help='Test a spider with limited items')
    test_parser.add_argument('spider', help='Spider name to test')
    test_parser.add_argument('--limit', '-l', type=int, default=5, help='Number of items to test')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return
    
    if args.command == 'crawl':
        run_spider(args.spider, args.output, args.limit)
    elif args.command == 'list':
        list_spiders()
    elif args.command == 'test':
        test_spider(args.spider, args.limit)

def run_spider(spider_name, output_file=None, limit=None):
    """Run a Scrapy spider"""
    cmd = ['scrapy', 'crawl', spider_name]
    
    if output_file:
        cmd.extend(['-o', output_file])
    
    if limit:
        cmd.extend(['-s', f'CLOSESPIDER_ITEMCOUNT={limit}'])
    
    print(f"ğŸš€ Running spider: {spider_name}")
    subprocess.run(cmd)

def test_spider(spider_name, limit=5):
    """Test a spider with limited items"""
    print(f"ğŸ§ª Testing spider: {spider_name} (limit: {limit})")
    cmd = ['scrapy', 'crawl', spider_name, '-s', f'CLOSESPIDER_ITEMCOUNT={limit}']
    subprocess.run(cmd)

def list_spiders():
    """List available spiders"""
    print("ğŸ“‹ Available spiders:")
    try:
        result = subprocess.run(['scrapy', 'list'], capture_output=True, text=True)
        if result.stdout:
            for spider in result.stdout.strip().split('\n'):
                if spider.strip():
                    print(f"  â€¢ {spider.strip()}")
        else:
            print("  No spiders found. Ask Claude Code to create some!")
    except Exception as e:
        print(f"  Error listing spiders: {e}")

if __name__ == '__main__':
    main()